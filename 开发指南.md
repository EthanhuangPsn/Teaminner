# 游戏语音服务 - 开发指南

## 项目结构

```
.
├── backend/          # NestJS 后端服务
├── frontend/         # React + Vite 前端应用
├── docker-compose.yml # Docker 容器配置（可选）
└── README.MD         # 项目需求文档
```

## 环境要求

- Node.js 18+
- npm 或 cnpm（推荐使用cnpm，更稳定）
- SQLite（已配置，无需额外安装）

## 快速开始

### 1. 安装依赖

#### 后端
```bash
cd backend
cnpm install
```

#### 前端
```bash
cd frontend
cnpm install
```

### 2. 初始化数据库

```bash
cd backend
npx prisma generate
npx prisma migrate dev
```

### 3. 启动服务

#### 启动后端（终端1）
```bash
cd backend
npm run start:dev
```

后端服务将在 `http://localhost:3000` 启动

#### 启动前端（终端2）
```bash
cd frontend
npm run dev
```

前端应用将在 `http://localhost:5173` 启动

## 功能说明

### 已实现功能

1. **用户认证**
   - 游客登录
   - JWT Token 认证

2. **房间管理**
   - 房间列表查看
   - 加入/离开房间
   - 房间状态切换（备战/攻坚）

3. **编队系统**
   - 小队管理（红、黄、绿）
   - 加入/退出小队
   - 队长指定

4. **实时通信**
   - WebSocket 状态同步
   - 房间状态实时更新

5. **音频系统（基础）**
   - mediasoup 集成
   - WebRTC 音频路由框架

### 待完善功能

1. **前端 WebRTC 集成**
   - 音频流采集
   - 音频流播放
   - 与 mediasoup 服务端连接

2. **音频质量优化**
   - 噪声抑制
   - 回声消除
   - 自动增益控制

3. **UI 完善**
   - 音频设备选择
   - 音量调节
   - 发言状态可视化

## API 端点

### 认证
- `POST /auth/guest` - 游客登录

### 房间
- `GET /rooms` - 获取房间列表
- `GET /rooms/:id` - 获取房间详情
- `POST /rooms/:id/join` - 加入房间
- `POST /rooms/leave` - 离开房间
- `PATCH /rooms/:id/status` - 切换房间状态

### 编队
- `POST /teams/:id/join` - 加入小队
- `DELETE /teams/leave` - 退出小队
- `POST /teams/:id/captain` - 指定队长

## WebSocket 事件

### 客户端发送
- `subscribe-room` - 订阅房间更新
- `unsubscribe-room` - 取消订阅

### 服务端推送
- `room-updated` - 房间状态更新
- `room-state-changed` - 房间状态变更

## 技术栈

### 后端
- NestJS
- Prisma (SQLite)
- mediasoup (WebRTC SFU)
- Socket.io (WebSocket)
- JWT (认证)

### 前端
- React 18
- TypeScript
- Vite
- Ant Design
- Zustand (状态管理)
- Socket.io-client

## 开发注意事项

1. **使用 cnpm 安装依赖**：更稳定，速度更快
   ```bash
   npm install -g cnpm --registry=https://registry.npmmirror.com
   ```

2. **数据库迁移**：修改 Prisma schema 后需要运行
   ```bash
   npx prisma migrate dev
   ```

3. **环境变量**：后端 `.env` 文件已配置，无需修改（使用 SQLite）

4. **CORS**：后端已启用 CORS，允许所有来源（开发环境）

## 常见问题

### 1. Prisma Client 初始化错误
如果遇到 Prisma Client 初始化错误，运行：
```bash
cd backend
npx prisma generate
```

### 2. 端口被占用
修改 `backend/src/main.ts` 中的端口号，或设置环境变量：
```bash
PORT=3001 npm run start:dev
```

### 3. 前端无法连接后端
检查：
- 后端是否正常运行
- CORS 配置是否正确
- API 地址是否正确（默认 `http://localhost:3000`）

## 下一步开发计划

1. 完善前端 WebRTC 客户端集成
2. 实现音频路由逻辑（攻坚模式）
3. 添加音频质量处理
4. 完善 UI/UX
5. 添加错误处理和用户提示
6. 性能优化

## 贡献指南

1. 遵循现有代码风格
2. 提交前运行 lint 检查
3. 添加必要的注释
4. 测试新功能
