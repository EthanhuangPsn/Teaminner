# 软件需求说明
## 概要
设计一款供多人在线使用的游戏语音服务，包含后端与前端，最终交付形式为，用户点击网络链接即可加入语音。
最终交互希望能够商业化。
## 详细说明
### 用户身份说明
用户身份根据是否进入房间，分为账号身份与房间身份，两者互不干扰。
1. 进入房间前，用户身份分为管理员与普通用户，此为账号身份。
2. 进入房间后，用户身份分为房间管理员，团长，队长，队员，为编队成员，此为房间身份。管理员自动继承房间管理员身份。

### 语音房间系统
1. 语音系统提供语音房间，仅后端服务人员可以管控房间数量，后端服务人员账号称为管理员，默认提供一个房间，普通用户仅可加入或者退出房间。
2. 用户登录之后，需进入一个房间，以使用游戏语音系统。
3. 一个语音房间最多可以支持20个用户。
4. 一个启用的房间必须具有一个房主，也成为“攻坚团团长”，简称团长。
5. 管理员可以指定团长。
5. 在没有指定团长时，第一个进入房间，并开启房间语音服务的用户，自动设定为团长。
6. 团长可以转让给其他房间内任意成员。
7. 语音房间提供小队系统，一个语音房间最多可以支持5个小队，分别以颜色命名小队，红，黄，绿，蓝，紫。默认仅提供红，黄，绿三个小队。
8. 每个小队，至多容纳5人。
9. 小队具有一个队长，队长可以自行转让给同队成员，或者由团长指定。
10. 用户刚进入时，处于未分队状态，可自行加入任意小队。团长也可以进行指定用户到某个队伍，实现编队的作用。
### 语音通话系统
用户自己可以设置自己的麦克风开启或者关闭，收听语音的开启或者关闭，这是用户端的设置，与房间状态无关。但发言是否能够传递到其他用户，则会受到更高的房间权限限制，这个限制在服务端进行实现，此为本语音服务的核心。
**重要说明：本系统的所有语音通信关系均为双向通信。即如果用户A可以听到用户B的发言，则用户B也可以听到用户A的发言。不存在单向通信场景，这简化了音频路由的实现复杂度。**
一个房间具有2种状态（后续可支持扩展），攻坚，备战。由团长进行选择房间状态。根据房间状态，用户的发言权限不同，以下为详细说明。
#### 备战
1. 备战状态是一个休闲状态，所有成员均可自由发言，不做任何限制。
#### 攻坚
1. 攻坚状态代表游戏已经开始，为了让各队有效协调，对成员的发言进行管控。
2. **团长与队长之间**：团长可以与所有队长进行双向语音通信，团长可以听到所有队长的发言，所有队长也可以听到团长的发言。
3. **队长之间**：不同小队的队长之间可以进行双向语音通信，便于跨队协调。
4. **队长与同队队员之间**：队长可以与同队所有队员进行双向语音通信，队长可以听到同队队员的发言，同队队员也可以听到队长的发言。
5. **同队队员之间**：同一小队的队员之间可以进行双向语音通信，便于队内协作。
6. **未编队的用户**：未编队的用户发言无法被任何人听到，也无法听到任何人的发言（处于静默状态）。

**攻坚状态下的音频路由关系表**（双向通信，A能听到B则B也能听到A）：

| 用户A身份 | 用户B身份 | 是否可通信 | 说明 |
|---------|---------|----------|------|
| 团长 | 任意队长 | ✅ | 团长与所有队长互通 |
| 团长 | 同队队员 | ✅ | 如果团长同时担任某队队长，则与该队队员互通 |
| 团长 | 其他队队员 | ❌ | 团长不能直接与其他队队员通信 |
| 团长 | 未编队用户 | ❌ | 团长不能与未编队用户通信 |
| 队长A | 队长B（不同队） | ✅ | 所有队长之间互通 |
| 队长 | 同队队员 | ✅ | 队长与同队所有队员互通 |
| 队长 | 其他队队员 | ❌ | 队长不能与其他队队员直接通信 |
| 队长 | 未编队用户 | ❌ | 队长不能与未编队用户通信 |
| 队员A | 队员B（同队） | ✅ | 同队队员之间互通 |
| 队员A | 队员B（不同队） | ❌ | 不同队队员之间不能直接通信 |
| 队员 | 未编队用户 | ❌ | 队员不能与未编队用户通信 |
| 未编队用户 | 任意用户 | ❌ | 未编队用户完全静默 |

**特殊情况**：
- 如果团长同时担任某队队长，则该团长同时具有团长和队长的所有通信权限
- 房间管理员（管理员账号）在房间内的通信权限与其实际身份（团长/队长/队员）相同，无额外通信权限

#### 音频质量保障
为了确保在游戏环境下（如机械键盘噪音、游戏音效、环境噪音等）提供清晰的语音通话体验，系统需要在客户端和服务端实现以下音频处理能力：
1. **噪声抑制（Noise Suppression）**
   - 自动识别并过滤背景噪音，如键盘敲击声、风扇声、环境杂音等
   - 保留人声频率范围，确保语音清晰度
   - 支持用户手动调节降噪强度等级（轻度/中度/强度）
2. **回声消除（Acoustic Echo Cancellation, AEC）**
   - 消除扬声器播放的声音被麦克风重新采集导致的回声
   - 特别适用于用户使用音响而非耳机的场景
   - 防止用户听到自己的声音回传
3. **自动增益控制（Automatic Gain Control, AGC）**
   - 自动调节麦克风输入音量，确保不同用户之间的音量平衡
   - 防止用户因距离麦克风远近不同导致的音量差异过大
   - 避免音量过大导致的失真或过小导致的听不清
4. **语音活动检测（Voice Activity Detection, VAD）**
   - 智能识别用户是否在说话，仅在检测到语音时传输音频数据
   - 减少无效数据传输，降低带宽占用
   - 配合UI动效，准确显示用户发言状态
5. **音频编解码优化**
   - 采用低延迟音频编解码算法（如Opus），确保实时性
   - 根据网络状况自适应调整码率，平衡音质与延迟
   - 支持丢包补偿，在网络波动时保持通话连续性
6. **用户端音频设置**
   - 提供麦克风输入音量手动调节滑块
   - 提供扬声器/耳机输出音量调节
   - 提供音频测试功能，允许用户测试麦克风和扬声器效果
   - 支持用户选择音频输入/输出设备（多设备切换）


### UI设计
1. 用户进入服务后，主界面为各个房间的罗列，需要显示房间当前是否开启，在线人数。
2. 用户选择一个房间进入后，则显示房间页面。
3. 房间页面左侧边栏会显示所有的用户清单，以及分队情况，团长队长做特殊标记。
4. 每个用户的图标上，应该展示当前用户设置的麦克风状态，收听状态，用户发言时，提供动效来展示用户正在说话。
5. 房间页面的主界面，则以圆形图标罗列当前可以有效对话到的成员的头像，根据房间成员状态，动态更新，以提示用户，你说的话可以被列表中的人听到。

### 账号系统
1. **注册与登录**：
   - 用户需要先注册账号，以登录本服务。
   - 用户可以使用自己的账号与密码进行登录。
2. **游客登录模式**：
   - 用户可以不输入账号，以游客身份登录。
   - **有效期**：游客账号根据最后活跃时间保留 1 天。服务器每天执行一次清理任务，删除那些超过 24 小时未登录的过期游客账号。
   - **级联删除**：当游客账号被清理时，系统将自动解除该用户在所有房间的占用状态，并触发身份转让逻辑（如该用户是团长，则自动移交）。
3. **IP 自动登录逻辑**：
   - 每次用户登录（无论是注册用户还是游客），系统会记录用户登录的当前 IP。
   - **自动识别**：当用户再次访问服务且本地缓存（Token）失效时，系统会尝试匹配该 IP 对应的前一次登录账号并尝试自动登录。
   - **安全性补充**：
     - 系统将 IP 与设备指纹（如浏览器特征）结合记录，以降低在公司、网吧等共用公网 IP 环境下账号被误登的风险。
     - 如果检测到同一 IP 在短时间内有多个不同账号登录，系统将禁用该 IP 的自动登录功能，强制用户手动输入。
   - **记录清理**：IP 与账号的绑定记录每天定时清理，删除那些超过 24 小时未活跃的绑定关系。
4. **后台管理员**：
   - 后台管理员的账号与密码不通过注册生成，而是单独提供一个服务器配置文件（如 `admin-config.json` 或环境变量）进行硬编码编写。
   - 管理员账号具有全局房间管控权限，进入房间后自动获得“房间管理员”身份。
5. **第三方快捷登录**：
   - 未来支持 QQ 快捷登录。系统只需保留 QQ 的 OpenID、头像、昵称，并以此创建本服务的唯一账号。
   - 该类账号仅支持 QQ 扫码或跳转登录，不支持设置账号密码登录。

### 边界情况与异常处理
#### 房间容量与编队限制
1. **房间满员处理**：当房间达到20人上限时，新用户尝试加入应提示"房间已满"，不允许进入。管理员可以查看房间满员情况，决定是否创建新房间。
2. **小队满员处理**：当某个小队达到5人上限时，用户尝试加入该小队应提示"该小队已满"，用户可选择加入其他未满的小队。团长可以强制将用户分配到已满的小队（需要先移除该小队的某个成员，或提示需要先调整编队）。
3. **小队数量限制**：当需要启用第4、5个小队（蓝、紫）时，需要明确启用条件和权限（是否由管理员控制，还是团长可以启用）。

#### 身份转让的边界情况
1. **团长转让**：
   - 团长可以转让给房间内任意成员（包括未编队成员、队长、队员）
   - 转让后，原团长身份变为普通成员，保留其原有编队状态（如果原团长是队长，则保留队长身份；如果是队员，则保留队员身份；如果未编队，则仍为未编队）
   - 新团长如果是未编队成员，获得团长身份后仍处于未编队状态，在攻坚模式下无法发言，需要自行加入小队或由其他成员协助编队
2. **队长转让**：
   - 队长只能转让给同队成员（不能转让给其他队成员或未编队成员）
   - 转让后，原队长身份变为队员，新队长获得队长身份
   - 如果小队只有队长一人，队长不能转让（或转让后小队解散，需要明确处理逻辑）
3. **团长同时担任队长**：允许团长同时担任某个小队的队长，此时团长具有双重身份，可以同时与所有队长通信，也可以与同队队员通信。

#### 房间状态切换
1. **从备战切换到攻坚**：
   - 切换时，系统应给所有未编队成员发送提示："房间已进入攻坚状态，请加入小队以使用语音功能"
   - 已编队成员的音频路由立即切换，未编队成员立即进入静默状态
   - UI应清晰显示当前房间状态，以及状态切换的提示
2. **从攻坚切换到备战**：
   - 所有成员的音频路由立即切换为全房间广播模式
   - 未编队成员恢复语音功能，可以听到所有人，也可以被所有人听到

#### 用户离线与重连
1. **用户断线处理**：
   - 用户网络断开时，系统应保留用户的身份、编队状态、房间信息，保留时长为5分钟
   - 其他用户界面应显示该用户为"离线"状态（灰色显示或特殊标记）
   - 如果离线用户是团长，且离线超过5分钟，系统需要自动指定新团长（优先级：当前在线队长 > 第一个进入房间的在线成员）
2. **用户重连处理**：
   - 用户在5分钟内重连，自动恢复身份、编队状态，无缝继续使用
   - 超过5分钟重连，视为新用户进入，需要重新加入房间和编队
   - 重连时，如果原房间已满，提示用户房间已满，无法重连
3. **游客身份过期**：游客身份过期后，如果用户正在房间内，应提示"会话已过期，请重新登录"，并引导用户注册或登录。

#### 房间管理
1. **房间创建与删除**：
   - 管理员可以创建新房间，设置房间名称、描述等信息
   - 管理员可以删除房间，删除前应检查房间内是否有用户，如有用户应提示"房间内仍有用户，无法删除"或"强制清空房间"
   - 删除房间时，房间内所有用户应被强制退出，并提示"房间已被管理员删除"
2. **房间启用与禁用**：
   - 管理员可以禁用房间，禁用后新用户无法加入，但已进入的用户可以继续使用
   - 房间禁用时，应在房间列表显示"已禁用"状态

#### 权限冲突与安全
1. **并发操作处理**：
   - 当多个用户同时尝试加入已满的小队时，系统应使用队列或先到先得机制
   - 当团长和用户同时操作（如团长指定用户到A队，用户同时尝试加入B队），应以团长的操作为准
2. **恶意行为防护**：
   - 防止用户频繁加入/退出房间造成系统负载
   - 防止用户频繁切换小队造成音频路由频繁变更
   - 考虑添加操作频率限制（如：1分钟内最多切换小队3次）

### 待明确的设计细节
#### 数据模型与用户信息
1. **用户基本信息**：
   - 注册用户需要设置哪些信息？（昵称、头像、密码等）
   - 游客用户的昵称如何生成？（随机生成、用户输入、还是"游客+ID"）
   - 用户头像如何设置？（上传图片、选择预设头像、还是仅QQ登录时使用QQ头像）
   - 昵称和头像是否可以在房间内修改？修改后是否需要其他用户刷新才能看到？
2. **游客身份管理**：
   - 游客会话ID的生成规则（UUID、时间戳+随机数等）
   - 游客信息的存储位置（本地存储、服务端临时存储）
   - 游客身份的具体过期时间（如：24小时、7天，还是从最后活动时间开始计算）
   - 游客过期后，用户重新访问时是否自动创建新的游客身份

#### 房间系统细节
1. **房间初始状态**：
   - 新创建的房间默认状态是什么？（备战还是攻坚）
   - 房间创建时是否需要设置房间名称、描述、密码等信息
   - 房间的可见性（公开房间、私密房间、密码房间）
2. **房间列表**：
   - 房间列表的排序规则（按在线人数、创建时间、房间名称等）
   - 是否支持房间搜索功能
   - 房间列表的刷新机制（实时推送、定时刷新、手动刷新）
3. **用户进入房间流程**：
   - "第一个进入房间，并开启房间语音服务的用户"中的"开启房间语音服务"具体指什么？（开启麦克风权限、点击某个按钮、还是自动开启）
   - 用户进入房间时，是否需要确认步骤，还是直接进入
   - 用户能否同时加入多个房间？（通常应该不允许，但需要明确）

#### 编队系统细节
1. **小队管理**：
   - 蓝、紫小队的启用方式（管理员启用、团长启用、还是自动启用当红黄绿小队满员时）
   - 小队是否可以删除或禁用（如：禁用某个小队，强制该小队成员重新编队）
   - 小队创建时是否需要设置小队名称（除了颜色外）
2. **用户编队操作**：
   - 用户如何退出当前小队？（是否有"退出小队"按钮，还是只能加入其他小队）
   - 用户退出小队后，是否立即回到未编队状态
   - 团长指定用户编队时，如果目标小队已满，是否自动移除该小队的某个成员，还是提示失败
   - 用户自行加入小队时，是否需要队长或团长批准

#### 权限系统细节
1. **房间管理员权限**：
   - 房间管理员（管理员账号进入房间后）的具体权限是什么？
   - 房间管理员与团长的权限区别（如：房间管理员能否修改房间状态、能否指定团长、能否踢出用户）
   - 房间管理员是否可以在多个房间同时拥有管理员身份
2. **用户管理权限**：
   - 团长或管理员能否踢出房间内的用户？
   - 踢出用户时，是否需要理由或提示
   - 被踢出的用户能否立即重新加入房间
   - 是否支持用户禁言功能（临时禁止某个用户发言，但不踢出房间）

#### 音频系统细节
1. **音频路由规则的精确定义**：
   - 需要明确列出所有可能的用户身份组合，以及它们之间的通信关系
   - 例如：团长A（同时是红队队长）与红队队员B、黄队队长C、黄队队员D之间的通信关系矩阵
   - 建议：使用表格或状态图明确展示所有通信关系
2. **音频权限的优先级**：
   - 当用户同时具有多个身份时（如团长+队长），音频路由如何计算
   - 用户麦克风关闭时，是否仍然占用音频路由资源
3. **音频设备权限**：
   - 浏览器请求麦克风权限的时机（进入房间时、点击开启麦克风时、还是首次访问时）
   - 用户拒绝麦克风权限时的处理（提示、引导、还是允许以只收听模式进入）
   - 麦克风权限被系统撤销时的处理（如：用户在其他应用中使用麦克风）

#### 状态管理细节
1. **用户离开房间**：
   - 用户主动退出房间时，身份和编队状态是否保留（通常不保留，但需要明确）
   - 用户退出房间后，能否立即重新加入原房间
   - 如果用户退出房间时是团长，房间如何处理（自动指定新团长、还是房间进入无团长状态）
2. **房间状态持久化**：
   - 房间状态（备战/攻坚）、编队信息是否需要持久化存储
   - 服务器重启后，房间状态如何恢复
   - 房间内所有用户都离开后，房间状态是否重置

#### UI交互细节
1. **房间页面布局**：
   - 左侧边栏的用户列表是否需要支持排序（按身份、按小队、按在线状态）
   - 用户列表是否需要支持搜索功能
   - 主界面的"可对话成员"圆形图标是否需要支持点击查看详情
2. **状态提示**：
   - 用户发言时的动效具体形式（图标闪烁、边框高亮、音量条等）
   - 网络质量差的提示方式（图标、文字、还是弹窗）
   - 房间状态切换时的提示方式（顶部横幅、弹窗、还是侧边通知）
3. **操作反馈**：
   - 用户操作（加入小队、转让身份等）是否需要加载状态提示
   - 操作失败时的错误提示方式（Toast、弹窗、还是内联提示）

#### API与协议设计
1. **通信协议**：
   - 客户端与服务端的通信协议（REST API、WebSocket、GraphQL等）
   - 状态同步的消息格式（JSON、Protocol Buffers等）
   - 音频流的传输协议（WebRTC、自定义协议等）
2. **API端点设计**（需要明确的主要接口）：
   - 用户认证相关：注册、登录、游客登录、登出
   - 房间相关：获取房间列表、加入房间、退出房间、创建房间（管理员）、删除房间（管理员）
   - 编队相关：加入小队、退出小队、指定用户编队、转让队长
   - 身份相关：转让团长、指定队长
   - 状态相关：切换房间状态、获取房间状态、获取用户状态
   - 音频相关：获取音频路由信息、更新音频设置
3. **WebSocket事件设计**（需要明确的主要事件）：
   - 用户加入/离开房间
   - 用户编队变更
   - 身份变更（团长、队长转让）
   - 房间状态变更
   - 用户音频状态变更（麦克风开关、发言状态）
   - 网络质量变化

#### 核心数据结构设计（建议）
1. **用户数据结构**：
   ```
   User {
     userId: string (唯一标识)
     username: string (昵称)
     avatar: string (头像URL)
     accountType: 'registered' | 'guest' | 'qq' (账号类型)
     accountRole: 'admin' | 'user' (账号身份)
     roomRole: 'room_admin' | 'leader' | 'captain' | 'member' | null (房间身份)
     teamId: string | null (所属小队ID，null表示未编队)
     isOnline: boolean (是否在线)
     micEnabled: boolean (麦克风是否开启)
     speakerEnabled: boolean (扬声器是否开启)
     isSpeaking: boolean (是否正在发言)
   }
   ```

2. **房间数据结构**：
   ```
   Room {
     roomId: string (唯一标识)
     roomName: string (房间名称)
     status: 'preparing' | 'assaulting' (房间状态)
     maxUsers: number (最大用户数，默认20)
     currentUserCount: number (当前用户数)
     leaderId: string | null (团长ID)
     teams: Team[] (小队列表)
     isEnabled: boolean (是否启用)
     createdAt: timestamp (创建时间)
   }
   ```

3. **小队数据结构**：
   ```
   Team {
     teamId: string (唯一标识)
     teamColor: 'red' | 'yellow' | 'green' | 'blue' | 'purple' (小队颜色)
     captainId: string | null (队长ID)
     memberIds: string[] (队员ID列表，最多5人)
     isEnabled: boolean (是否启用，用于蓝紫小队的启用控制)
   }
   ```

4. **音频路由表结构**（服务端维护）：
   ```
   AudioRoute {
     fromUserId: string (发送者ID)
     toUserId: string (接收者ID)
     enabled: boolean (是否启用该路由)
     roomId: string (所属房间)
     lastUpdated: timestamp (最后更新时间)
   }
   ```
   路由表计算规则：根据房间状态、用户身份、编队信息实时计算，当这些信息变更时重新计算。

5. **状态变更事件结构**：
   ```
   StateChangeEvent {
     eventType: 'user_joined' | 'user_left' | 'team_changed' | 'role_changed' | 'room_status_changed'
     roomId: string
     userId?: string (相关用户ID)
     timestamp: timestamp
     data: object (事件相关数据)
   }
   ```

#### 关键业务流程说明
1. **用户进入房间流程**：
   ```
   1. 用户选择房间 → 检查房间是否满员 → 检查房间是否启用
   2. 请求加入房间 → 服务端验证权限 → 分配用户ID（如果是游客）
   3. 建立WebSocket连接 → 建立WebRTC连接（请求麦克风权限）
   4. 服务端广播"用户加入"事件 → 更新音频路由表
   5. 客户端接收房间状态（用户列表、编队信息、房间状态）
   6. 如果房间无团长且用户开启了麦克风 → 自动指定为团长
   ```

2. **房间状态切换流程**（备战 ↔ 攻坚）：
   ```
   1. 团长点击切换状态按钮 → 服务端验证权限
   2. 服务端更新房间状态 → 重新计算所有用户的音频路由表
   3. 服务端广播"房间状态变更"事件 → 所有客户端接收事件
   4. 服务端通知SFU更新音频路由 → SFU平滑切换音频流
   5. 客户端更新UI显示新状态 → 如果是切换到攻坚，提示未编队用户
   6. 如果切换到攻坚，未编队用户立即静默（停止发送和接收音频）
   ```

3. **用户编队流程**：
   ```
   方式1：用户自行加入
   1. 用户点击"加入小队" → 检查目标小队是否满员
   2. 服务端更新用户teamId → 重新计算音频路由表
   3. 服务端广播"编队变更"事件 → 更新所有客户端UI
   4. 服务端通知SFU更新音频路由 → 平滑切换音频流
   
   方式2：团长指定
   1. 团长选择用户和目标小队 → 检查目标小队是否满员
   2. 如果满员，提示团长先调整编队或自动移除某个成员
   3. 服务端更新用户teamId → 后续流程同方式1
   ```

4. **身份转让流程**（团长/队长转让）：
   ```
   团长转让：
   1. 团长选择目标用户 → 服务端验证目标用户在房间内
   2. 服务端更新leaderId → 原团长保留其他身份（队长/队员/未编队）
   3. 服务端重新计算音频路由表（如果原团长或新团长是队长）
   4. 服务端广播"身份变更"事件 → 更新所有客户端UI
   5. 服务端通知SFU更新音频路由
   
   队长转让：
   1. 队长选择同队成员 → 服务端验证目标用户在同队
   2. 服务端更新team.captainId → 原队长变为队员
   3. 服务端重新计算音频路由表（队长变更影响路由）
   4. 服务端广播"身份变更"事件 → 更新所有客户端UI
   5. 服务端通知SFU更新音频路由
   ```

5. **音频路由表计算算法**（服务端核心逻辑）：
   ```
   函数：calculateAudioRoutes(room)
   输入：房间对象（包含状态、用户列表、编队信息）
   输出：音频路由表数组
   
   算法步骤：
   1. 初始化空路由表
   2. 如果房间状态为"备战"：
      - 遍历房间内所有用户对 (userA, userB)
      - 如果userA.micEnabled && userB.speakerEnabled，添加双向路由
   3. 如果房间状态为"攻坚"：
      - 遍历房间内所有用户对 (userA, userB)
      - 根据用户身份和编队关系，判断是否可通信（参考路由关系表）
      - 如果可通信 && userA.micEnabled && userB.speakerEnabled，添加双向路由
   4. 返回路由表
   
   注意：路由表需要实时更新，当以下情况发生时触发重新计算：
   - 用户加入/离开房间
   - 用户编队变更
   - 用户身份变更（团长/队长）
   - 房间状态切换
   - 用户麦克风/扬声器状态变更（客户端通知服务端）
   ```

#### 安全与性能
1. **安全措施**：
   - 用户认证方式（JWT、Session、OAuth等）
   - API请求的鉴权机制
   - 防止恶意请求的限流策略（每个用户、每个IP）
   - 音频流的加密传输（DTLS、SRTP等）
2. **性能指标**：
   - 音频延迟的目标值（如：< 200ms）
   - 支持的最大并发房间数
   - 单个SFU节点支持的最大并发用户数
   - 客户端资源占用目标（CPU、内存、带宽）

### 技术实现难点
#### 实时音频路由管理
1. **动态路由更新**：
   - 当用户编队、转让身份、房间状态切换时，音频路由需要实时更新，且不能中断正在进行的语音通话
   - 实现方案：采用"路由表预计算 + 平滑切换"机制，在状态变更前预计算新路由表，使用WebRTC的transceiver API实现无感知切换
   - 难点：确保所有客户端同时切换，避免出现短暂的单向通信
2. **路由表复杂度**：
   - 20人房间，理论上最多需要维护 20×19÷2 = 190 个双向音频流
   - 优化方案：采用SFU（Selective Forwarding Unit）架构，每个用户只与SFU服务器建立上行和下行连接，由SFU根据路由表进行音频转发，减少P2P连接数
   - 实际连接数：20个用户 × 2（上行+下行）= 40个连接，而非190个

#### 网络稳定性保障
1. **断线重连机制**：
   - WebRTC连接断开后，需要快速检测并重建连接
   - 实现ICE（Interactive Connectivity Establishment）重连机制，支持NAT穿透
   - 重连时保持音频路由状态，避免用户需要重新编队
2. **网络质量自适应**：
   - 实时监控每个用户的网络质量（延迟、丢包率、带宽）
   - 当网络质量下降时，自动降低码率或启用更强的丢包补偿
   - 当网络质量极差时，提示用户网络不稳定，建议检查网络

#### 状态同步与一致性
1. **分布式状态管理**：
   - 房间状态、用户身份、编队信息需要在所有客户端和服务端保持一致
   - 采用"服务端权威 + 客户端预测"模式：服务端维护权威状态，客户端接收状态变更事件并立即更新UI
   - 使用WebSocket或类似实时通信协议，确保状态变更的实时推送
2. **冲突解决**：
   - 当客户端和服务端状态不一致时（如网络延迟导致），以服务端状态为准
   - 实现状态版本号机制，客户端收到新版本状态时自动同步

#### 浏览器兼容性与限制
1. **WebRTC浏览器支持**：
   - 不同浏览器对WebRTC的支持程度不同，需要处理兼容性问题
   - 移动端浏览器（特别是iOS Safari）对WebRTC的支持有限，需要特殊处理
   - 考虑提供降级方案：当浏览器不支持WebRTC时，提示用户使用支持的浏览器
2. **后台运行限制**：
   - 移动端浏览器在后台运行时，WebRTC连接可能被系统中断
   - 桌面端浏览器在标签页切换时，也可能降低音频处理优先级
   - 需要实现"连接保活"机制，定期发送心跳包，检测连接状态

#### 性能优化
1. **音频处理性能**：
   - 噪声抑制、回声消除等音频处理算法计算量大，需要在客户端高效实现
   - 考虑使用WebAssembly（WASM）实现音频处理算法，提升性能
   - 或使用浏览器原生API（如Web Audio API）进行音频处理
2. **服务端负载**：
   - SFU服务器需要处理大量并发的音频流，对CPU和带宽要求高
   - 考虑使用CDN或边缘节点，将音频转发节点部署到用户附近，降低延迟
   - 实现负载均衡，当单个房间用户过多时，可以分散到多个SFU节点